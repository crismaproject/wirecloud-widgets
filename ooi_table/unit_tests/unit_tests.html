<!DOCTYPE html>
<html>
<head>
    <title></title>
    <link rel="stylesheet" href="http://code.jquery.com/qunit/qunit-1.12.0.css">
    <script src="http://code.jquery.com/jquery-2.0.3.min.js" type="text/javascript"></script>
    <script type="text/javascript" src="../js/main.js"></script>
    <script type="text/javascript">
        /**
         * Dummy implementation for the most important functions exposed by the Wirecloud API
         */
        var MashupPlatform = {
            wiring: {
                callbacks: { },

                registerCallback: function (name, handler) {
                    if (!this.callbacks.hasOwnProperty(name))
                        this.callbacks[name] = [ handler ];
                    else
                        this.callbacks[name].push(handler);
                },
                pushEvent: function (name, data) {
                    for (var i = 0; i < this.callbacks[name].length; i++)
                        this.callbacks[name][i](data);
                }
            }
        };
    </script>
    <script type="text/javascript" src="../js/wirecloud.js"></script>
</head>
<body>
    <div id="qunit"></div>
    <div id="qunit-fixtures"></div>
    <table id="ooi-table" style="display: none">
        <tbody>
        </tbody>
    </table>
    <script type="text/javascript" src="http://code.jquery.com/qunit/qunit-1.12.0.js"></script>
    <script type="text/javascript">
        var table = new OOITable('#ooi-table');

        test('Items can be added', function () {
            MashupPlatform.wiring.pushEvent('oois_in', JSON.stringify([
                { id: 'amb-1', type: 'Ambulance', site: '34, 31' },
                { id: 'amb-2', type: 'Ambulance', site: '34.1, 30.9' },
                { id: 'amb-4', type: 'Ambulance', site: '34.25, 30.2' }
            ]));

            equal($('#ooi-table tbody tr[data-row-id]').length, 3, 'Three rows have been added to the table');
            equal($('#ooi-table tbody tr[data-row-id].selected').length, 0, 'No items are selected (yet)');
        });

        test('Items can be selected', function () {
            MashupPlatform.wiring.pushEvent('oois_selected_in', JSON.stringify([
                { id: 'amb-1' },
                { id: 'amb-2' }
            ]));

            equal($('#ooi-table tbody tr[data-row-id].selected').length, 2, 'Two items are selected');
        });

        test('All items can be unselected', function () {
            table.unselectAll();
            equal($('#ooi-table tbody tr[data-row-id].selected').length, 0, 'No items are selected');
        });

        test('Selection through UI causes selection to propagate down the wire', function () {
            var selection = [];
            MashupPlatform.wiring.registerCallback('oois_selected_out', function (data) {
                selection = JSON.parse(data);
            });

            $('tr[data-row-id="amb-4"]').click();
            ok($('tr[data-row-id="amb-4"]').is('.selected'), 'Clicked element receives CSS class "selected"');
            equal(selection.length, 1, 'One element has been propagated through ooi_selected_out');
            equal(selection[0].id, 'amb-4', 'That item is amb-4');
        });
    </script>
</body>
</html>